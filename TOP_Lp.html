<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Top Performer Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { background: #000; font-family: 'Inter', sans-serif; color: #fff; padding: 10px; margin: 0; }
    .dashboard-wrapper { display: flex; flex-direction: column; gap: 8px; max-width: 850px; margin: auto; }
    .driver-card {
      background: #111827; border-left: 4px solid #38bdf8; border-radius: 6px;
      padding: 10px 15px; display: grid; grid-template-columns: 1.2fr 1fr 1.2fr 1.1fr; 
      gap: 15px; align-items: center; font-size: 0.85rem;
    }
    .top-spot { background: #451a03; border-left: 6px solid #fbbf24; font-weight: 800; animation: gold-glow 1.5s infinite alternate; }
    @keyframes gold-glow { from { box-shadow: 0 0 5px #fbbf24; background: #451a03; } to { box-shadow: 0 0 20px #fbbf24; background: #78350f; } }
    .stat-group { display: flex; flex-direction: column; }
    .label { font-size: 0.65rem; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
    .val { color: #f8fafc; font-weight: 600; }
    .highlight { color: #38bdf8; font-size: 1rem; }
    .adr-color { color: #fbbf24; font-weight: 800; }
    .loading { text-align: center; padding: 20px; font-style: italic; color: #64748b; }
  </style>
</head>
<body>
  <div id="driver-stats-container" class="dashboard-wrapper">
    <div class="loading">Updating Leaderboard...</div>
  </div>

<script>
  // Strips symbols and forces a clean number for math calculations
  const toNum = (val) => {
    if (!val) return 0;
    // Strips $, quotes, commas, and spaces to get the full numeric value
    const clean = String(val).replace(/[^0-9.]/g, ""); 
    const n = parseFloat(clean);
    return isNaN(n) ? 0 : n;
  };
  
  // Formats numbers into clean Currency strings for display
  const toUSD = (val) => {
    return '$' + toNum(val).toLocaleString(undefined, {
      minimumFractionDigits: 2, 
      maximumFractionDigits: 2
    });
  };

  async function updateLeaderboard() {
    // URL for the "Copy of Driver Revenue L/P" sheet published as CSV
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXwF-92T09SgCmFnFLk6NjAWwK52BxFpyivdtrFtFWv-c4DdrF1jgpgZg7jWsyASCqVP7TxyDKVuH4/pub?gid=1773248352&single=true&output=csv';

    try {
      const response = await fetch(CSV_URL);
      const csvText = await response.text();
      
      // Smart Split: This is the key fix. It ignores commas inside quotes.
      const rows = csvText.split('\n').filter(line => line.trim() !== "").map(row => {
        const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
        return matches ? matches.map(m => m.replace(/^"|"$/g, "")) : [];
      });
      
      const container = document.getElementById('driver-stats-container');
      const dataRows = rows.slice(1);

      let drivers = dataRows.map(row => {
        // Ensure row has enough data (ID in Col A, Miles in E/F, Revenue in M, ADR in P)
        if (row.length < 16) return null;

        const empty = toNum(row[4]);  // Empty Miles (Column E)
        const loaded = toNum(row[5]); // Loaded Miles (Column F)
        const totalMiles = empty + loaded;
        
        // DH% Calculation (Empty / Total)
        const dh = totalMiles > 0 ? ((empty / totalMiles) * 100).toFixed(2) + '%' : '0.00%';

        return {
          id: row[0].trim(),           // Driver ID (Column A)
          miles: totalMiles.toLocaleString(), 
          deadhead: dh,
          revenue: toUSD(row[12]),      // Total Revenue (Column M)
          adrVal: toNum(row[15]),       // ADR for sorting (Column P)
          adrDisp: toUSD(row[15])       // ADR for display (Column P)
        };
      }).filter(d => d && d.id !== "" && d.id !== "Driver Id");

      // Sort by ADR Highest to Lowest
      drivers.sort((a, b) => b.adrVal - a.adrVal);

      container.innerHTML = '';
      drivers.slice(0, 7).forEach((driver, index) => {
        const isFirst = index === 0;
        const card = document.createElement('div');
        card.className = `driver-card ${isFirst ? 'top-spot' : ''}`;
        card.innerHTML = `
          <div class="stat-group">
            <span class="label">#${index + 1} DRIVER ID</span>
            <span class="val highlight">${driver.id}</span>
          </div>
          <div class="stat-group">
            <span class="label">TOTAL MILES | DH%</span>
            <span class="val">${driver.miles} | ${driver.deadhead}</span>
          </div>
          <div class="stat-group">
            <span class="label">TOTAL REVENUE</span>
            <span class="val">${driver.revenue}</span>
          </div>
          <div class="stat-group">
            <span class="label">ADR</span>
            <span class="val highlight adr-color">${driver.adrDisp}</span>
          </div>
        `;
        container.appendChild(card);
      });
    } catch (e) {
      console.error("Dashboard Error:", e);
    }
  }

  updateLeaderboard();
  setInterval(updateLeaderboard, 300000); // Auto-refresh every 5 minutes
</script>
</body>
</html>
